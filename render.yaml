services:
  # Platform API + Gateway (single instance)
  - type: web
    name: workforce
    runtime: node
    plan: starter  # Required for persistent disk
    buildCommand: |
      npm i -g pnpm@10 pm2 &&
      cd clawdbot && pnpm install && pnpm build && pnpm ui:build &&
      cd ../platform && pnpm install && pnpm build
    startCommand: pm2-runtime ecosystem.config.cjs --only gateway,platform
    envVars:
      - key: PORT
        value: 3000
      - key: TENANT_DATA_DIR
        value: /data/tenants
      - key: NODE_ENV
        value: production
      - key: CLAWDBOT_GATEWAY_URL
        value: http://127.0.0.1:18789
      # Secrets (set in Render dashboard)
      - key: SUPABASE_URL
        sync: false
      - key: SUPABASE_ANON_KEY
        sync: false
      - key: SUPABASE_SERVICE_KEY
        sync: false
      - key: DATABASE_URL
        sync: false
      - key: OPENROUTER_API_KEY
        sync: false
      - key: CLAWDBOT_HOOK_TOKEN
        sync: false
      - key: COMPOSIO_API_KEY
        sync: false
      - key: DEFAULT_MODEL
        value: google/gemini-2.0-flash-001
    disk:
      name: tenant-data
      mountPath: /data/tenants
      sizeGB: 1
    healthCheckPath: /health
